# Bussikartta Overview

## 1. Basic Overview

**Bussikartta** is a real-time transit tracking system designed for Helsinki Region Transport (HSL). It combines static schedule data with live vehicle telemetry to show real-time positions and delay information of buses on an interactive map.

### Key Functionalities

- **Static GTFS Schedule Import**: Imports routes, trips, stops, and timetables from HSL’s GTFS feed into a TimescaleDB database.
- **Live Data Ingestion**: Subscribes to HSL’s MQTT feed to receive live vehicle position updates and status events.
- **Delay Calculation**: Computes delays (ahead or behind schedule) by comparing live arrival times to scheduled times.
- **API for Clients**: Exposes REST and WebSocket endpoints via FastAPI for querying vehicles, delays, stops, and routes.
- **Interactive Frontend**: A SolidJS + Vite-based web app that displays bus positions and delays on an interactive vector tile map.
- **Containerized Setup**: Uses Docker Compose to orchestrate backend, frontend, tile server, and database services.

---

## 2. Detailed Overview

### 🏛 Architecture

The system comprises several coordinated services:

```
[ GTFS Feed ] ─── import_gtfs.py ──► [TimescaleDB Static GTFS Tables]
                   ↑
                   └─────────────────┐
                                     ▼
                                FastAPI Backend ◄─────────────
                   ▲           (REST APIs, WebSocket `/ws`)   │
                   │                                           │
[ HSL MQTT        └───────────────────────────────────────────►│
  Live Feed ]           MQTT Subscriber        Live Vehicle Data│
                                                         ▲     │
                                                         └─────┘
                                       SolidJS + MapLibre Frontend (WebSocket)
```

---

### Core Components

#### 1. `gtfs_static/main.py`
- Downloads and parses the GTFS ZIP feed from HSL.
- Populates static database tables: `routes`, `trips`, `stop_times`, `stops`, etc.

#### 2. `mqtt_hfp_ingest/main.py`
- Subscribes to the HSL MQTT broker (topic `/hfp/v2/journey/ongoing/vp/bus/#`).
- On each message, inserts vehicle telemetry into the `mqtt_hfp` hypertable.

#### 3. `api/` (FastAPI backend)
- Serves:
  - `/vehicles` (REST) — snapshot of latest positions.
  - `/ws` (WebSocket) — streams JSON vehicle updates every second.
- Responsible for:
  - Joining static and dynamic data.
  - Delivering low-latency access to vehicle feeds.

#### 4. `frontend/`
- Powered by **SolidJS + Vite**.
- Uses **MapLibre GL JS** to render fast vector tiles from:
  - HSL CDN (`hsl-vector-map`) or
  - Local `.mbtiles` via Tileserver-GL (optional).
- WebSocket-driven updates allow rendering 5,000+ live markers efficiently.

#### 5. `tileserver/` (optional)
- Dockerized **Tileserver-GL** instance.
- Serves `.mbtiles` generated by **Tilemaker** for offline use.

#### 6. `docker-compose.yml`
- Defines all services:
  - `api-server`, `db`, `mqtt-ingest`, `gtfs-static`, `bussikartta-ui`, `bussikartta-map`.
- Docker volumes are used for database persistence and optional tiles.

---

### 💡 Developer Highlights

- **WebSocket-first updates** — frontend connects to `/ws`, receives 1 Hz updates.
- **No React** — SolidJS ensures fast, minimal re-renders for map-heavy UIs.
- **Map tile options** — Online from CDN or offline from local `.mbtiles`.
- **Clear data flow** — Static (GTFS) and dynamic (MQTT) data merged in backend.

---

© HSL Bussikartta 2025
